# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 言語設定 (Language Configuration)

このプロジェクトは日本語環境での動作を前提としています。

- **コミュニケーション**: 日本語で対応してください
- **コメント**: コードコメントは日本語で記述
- **ドキュメント**: 技術文書は日本語で作成
- **エラーメッセージ**: 可能な限り日本語で表示
- **変数名・関数名**: 英語を使用（国際的な慣例に従う）

## プロジェクト状況 (mainブランチ)

本プロジェクトはScala3で書かれたApache Pekkoを利用したアプリケーションです。
urls.txtに存在する {サイト名}.com にアクセスしてそのサイトコンテンツを取得し、
com-sites.txt にサイト名ごとのタイトルを記載します。

[aaaaa.com](https://aaaaa.com)から[zzzzz.com](https://zzzzz.com)までの
ウェブサイトをしらみつぶしにアクセスして、閲覧が可能なサイトはテキストファイルに、サイトドメインとさいとタイトルを書き込みます。

まずはメッセージの処理速度などを全く加味せず Pekko Actor の耐障害性の性質だけを利用して、
一覧取得システムを設計していきます。

まずは、 Main クラスでこの一覧取得システムを起動します。<br>
利用する Actor は 3 つです。

- Supervisor
- UrlsFileLoader
- UrlsListMaker

以上となります。 Supervisor は Config という設定ファイルを持ち、
UrlsFileLoader という URL のファイルの一覧を読み込むアクターと
UrlsListMaker というウェブサイトにアクセスしURLの一覧を作るアクターの親アクターとなっています。

この 3 つのアクターが協調し合いながら、一覧を作っていくことを考えます。


では、これらのアクターがどのようにメッセージングをしていくかの流れを考えてみましょう。

ここでは、

1. Main が Supervisor をスタートさせる
1. Supervisor が UrlsFileLoader に URL の読み込みをスタートさせる
1. Supervisor が URL を受け取りそれを UrlsListMaker に送りアクセスさせる
1. UrlsListMaker が Supervisor に終了を通知する
1. Supervisor が Main に終了を通知する

この流れが最も単純な流れとして考えられるでしょう。


## mainブランチが持っている不具合

なお、このアプリケーションは大量にメモリを使うため、正しく動作しない可能性があります。<br>
場合によっては**途中でメモリを使い果たし、固まるか勝手に終了**してしまいます。


原因の大きな要因としては、

- 「URLをファイルよりロードを行うスピード」は、「ページをインターネットよりダウンロードするスピード」よりも圧倒的に早い

ということがあります。

仮に 2000 個のアクターを用意していたとしてもすべてのメッセージを消化できず、
WebPageLoader のメールボックスに大量のメッセージ溜まっていってしまうのです。

つまり 2000 並列であっても消化しきれないほどのパフォーマンスがあるということなのです。


## 解決案 (fix/out-of-memoryでは解決済み)

さて、これを直すにはどうすればよいのでしょうか。

一番簡単なのは、 WebPageLoader が最も時間のかかる処理であるので、
このアクターから問い合わせを開始してダウンロードする形式にすれば良いでしょう。<br>
このようなメッセージングを**問い合わせ型のメッセージング**といいます。

今までトップダウンに命令を送っていけば良いと言う考えでしたが、これを改め、個々のアクターが仕事が終わったら次の仕事をくださいと手を挙げる方式にするといことです。

まず Supervisor は WebPageLoader に LoadWebPage というメッセージを投げます。

そのメッセージを元に、 WebPageLoader はダウンロードしたい、
URL を 1 つだけ UrlsFileLoader に要求するのです。

そして受け取った URL を元にダウンロードした後、
自分自身にもう一度 LoadWebPage とうメッセージを投げて再度ダウンロードします。

つまり 2000 個で並列した アクターが必要になった分だけ URL をファイルから請求する構造にすることで、
メールボックスに沢山のメッセージが貯まることを防ぐことができるのです。

